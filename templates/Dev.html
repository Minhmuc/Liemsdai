<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Expert Mode - LMS Licker</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <style>
        @font-face {
            font-family: 'Minecraft';
            src: url('/static/Minecraft.ttf') format('truetype');
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: auto;
            background-color: #2C2F33;
            color: #e0e0e0;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        a, button, input, img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: auto;
        }

        .background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/static/hinhnen.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            filter: brightness(0.3) blur(5px);
            z-index: -1;
            opacity: 0.5;
        }

        .container { position: relative; z-index: 1; max-width: 800px; margin: 50px auto; padding: 20px; background-color: #23272A; border: 1px solid #333; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

        .header, .footer, .content h2, .button, .copy-button, .error { font-family: 'Minecraft', Arial, sans-serif; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 2em; color: #ffffff; }
        .content { padding: 20px; margin-bottom: 20px; }
        .content ul { list-style: none; padding: 0; margin: 0; }
        .content li { margin-bottom: 10px; }
        .content li strong { font-weight: bold; }
        .content h2 { margin-top: 0; color: #ffffff; }
        .footer { text-align: center; margin-top: 20px; color: #e0e0e0; }
        @media (max-width: 768px) { .container { margin: 20px auto; } }

        .file-input { display: flex; align-items: center; margin-bottom: 10px; }
        .file-input input[type="file"] { display: none; }
        .file-input span { margin-left: 10px; color: #e0e0e0; }
        .file-input label { background-color: #7289DA; color: #fff; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

        textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical; background-color: #333; color: #e0e0e0; }

        .button { background-color: #7289DA; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; display: none; }
        .button:hover { background-color: #5b6eae; }

        .copy-button { background-color: #3ba55d; color: #fff; padding: 10px 20px; transition: background-color 0.3s ease, box-shadow 0.3s ease; border: none; border-radius: 5px; cursor: pointer; }
        .copy-button:hover { background-color: #2d7d46; }

        .download-word-btn {
            background-color: #ffffff;
            color: #000000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Minecraft', Arial, sans-serif;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 10;
}

        .download-word-btn:hover {
            background-color: #adadad; /* n·ªÅn t·ªëi h∆°n */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

    </style>

    <!-- CDN cho docx v√† FileSaver -->
    <!-- d√πng jsDelivr UMD (·ªïn ƒë·ªãnh cho tr√¨nh duy·ªát) -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>

<!-- FileSaver fallback (n·∫øu b·∫°n th√≠ch d√πng saveAs). Kh√¥ng b·∫Øt bu·ªôc. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

</head>
<body>
    <div class="background-image"></div>
    <div class="container">
        <div class="header">
            <a href="/" style="color:#03A9F4; font-size: 1em; text-decoration: none; margin-right: 15px;">&#8962; Home</a>
            <a href="https://sml.utci.is-great.net" target="_blank" style="color:#7289DA; font-size: 1em; text-decoration: none; margin-right: 15px;">üîó SML</a>
            <h1>"Fortune & Glory, Kid."</h1>
        </div>

        <div class="content">
            <h2>Nh·∫≠p t·ªáp JSON/txt ho·∫∑c JSON code</h2>
            <form id="json-form" method="post" enctype="multipart/form-data">
                <div class="file-input">
                    <label for="file-input">Ch·ªçn t·ªáp</label>
                    <input type="file" id="file-input" name="file" multiple="multiple" onchange="toggleSubmitButton()">
                    <span id="file-name">Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn</span>
                </div>
                <textarea id="json-code" name="json_code" rows="10" cols="50" placeholder="Nh·∫≠p JSON code t·∫°i ƒë√¢y..." oninput="toggleOkButton()"></textarea>
                <div>
                    <button class="button" id="ok-button" type="button" onclick="submitJsonCode()">OK</button>
                    <button class="button" id="submit-button" type="submit">Li·∫øm lu√¥n</button>
                </div>
            </form>

            {% if questions %}
                <h2>C√°c c√¢u h·ªèi ƒë√£ ph√¢n t√≠ch:</h2>
                <p>T·ªïng s·ªë c√¢u h·ªèi: {{ total_questions }}</p>
                <div id="question-list">
                    {% for q in questions %}
                        {% if not q.get('L√† c√¢u gh√©p') and not q.get('L√† ƒë√°p √°n ƒëi·ªÅn') and not q.get('L√† c√¢u ƒë√∫ng/sai') %}
                        <div style="margin-bottom: 20px; padding: 10px; border-left: 3px solid #7289DA;">
                            <strong>ID:</strong> {{ q.ID }}<br>
                            <strong>{{ q.C√¢u }}</strong><br>
                            
                            {% if (q.Lo·∫°i == 'radio' or q.Lo·∫°i.startswith('checkbox')) and q.get('ƒê√°p √°n') %}
                                {% set answers = q.get('ƒê√°p √°n') %}
                                {% if answers and answers is mapping %}
                                    <ul>
                                        {% for key, value in answers.items() %}
                                            <li>{{ key }}. {{ value }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            
                            {% elif q.Lo·∫°i == 'group-radio' and q.get('C√≥ c√°c c√¢u ƒë√∫ng/sai') %}
                                <div style="margin-top: 10px; padding: 10px; background-color: #2C2F33; border-radius: 5px;">
                                    {% for sub_q in questions %}
                                        {% if sub_q.get('Parent_ID') == q.ID %}
                                            <div style="margin-top: 8px; padding-left: 15px;">
                                                <strong>{{ sub_q.C√¢u.split(': ', 1)[1] if ': ' in sub_q.C√¢u else sub_q.C√¢u }}</strong>
                                                {% if sub_q.get('ƒê√°p √°n') and sub_q['ƒê√°p √°n'] is mapping %}
                                                    <ul style="margin-top: 5px;">
                                                        {% for key, value in sub_q['ƒê√°p √°n'].items() %}
                                                            <li>{{ key }}. {{ value }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            
                            {% elif q.Lo·∫°i == 'drag_drop' and q.get('C√≥ c√°c c√¢u gh√©p') %}
                                <div style="margin-top: 10px; padding: 10px; background-color: #2C2F33; border-radius: 5px;">
                                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                                        <tr>
                                            {% for choice in q['C√°c l·ª±a ch·ªçn'] %}
                                                <td style="border: 1px solid #555; padding: 8px; text-align: center;">{{ choice }}</td>
                                            {% endfor %}
                                        </tr>
                                    </table>
                                    
                                    {% for sub_q in questions %}
                                        {% if sub_q.get('Parent_ID') == q.ID %}
                                            <div style="margin-top: 8px; padding-left: 15px;">
                                                - {{ sub_q.C√¢u.split(': ', 1)[1] if ': ' in sub_q.C√¢u else sub_q.C√¢u }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            
                            {% elif q.Lo·∫°i == 'group-input' and q.get('C√≥ c√°c c√¢u ƒëi·ªÅn') %}
                                <div style="margin-top: 10px; padding: 10px; background-color: #2C2F33; border-radius: 5px;">
                                    {% for sub_q in questions %}
                                        {% if sub_q.get('Parent_ID') == q.ID %}
                                            <div style="margin-top: 8px; padding-left: 15px; color: #3ba55d;">
                                                - {{ sub_q['ƒê√°p √°n'] if sub_q.get('ƒê√°p √°n') else sub_q.C√¢u.split(': ', 1)[1] }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div style="margin-top:12px;">
                    <button class="copy-button" onclick="copyToClipboard()" style="display: inline-flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <rect x="8" y="2" width="8" height="4" rx="1" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Copy
                    </button>

                    <button class="download-word-btn" onclick="downloadDocx()" style="display: inline-flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Download
                    </button>
                </div>
            {% endif %}

            {% if errors %}
                <h2>L·ªói:</h2>
                <ul>
                    {% for error in errors %}
                        <li class="error">{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <div class="footer">
            &copy; 2025 the liems
        </div>
    </div>

    <script>
        const fileInput = document.querySelector('.file-input input[type="file"]');
        const fileNameSpan = document.querySelector('.file-input #file-name');
        const submitButton = document.getElementById('submit-button');
        const okButton = document.getElementById('ok-button');
        const jsonCodeTextarea = document.getElementById('json-code');

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 1) {
                fileNameSpan.textContent = `${files.length} t·ªáp`;
            } else if (files.length === 1) {
                fileNameSpan.textContent = files[0].name;
            } else {
                fileNameSpan.textContent = "Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn";
            }
            toggleSubmitButton();
        });

        function toggleSubmitButton() {
            if (fileInput.files.length > 0) {
                submitButton.style.display = 'inline-block';
            } else {
                submitButton.style.display = 'none';
            }
        }

        function toggleOkButton() {
            if (jsonCodeTextarea.value.trim().length > 0) {
                okButton.style.display = 'inline-block';
            } else {
                okButton.style.display = 'none';
            }
        }

        function submitJsonCode() {
            const jsonCode = jsonCodeTextarea.value;
            fetch('/save_json_code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ json_code: jsonCode }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const file = new File([jsonCode], data.filename, { type: 'text/plain' });
                    const dataTransfer = new DataTransfer();
                    for (let i = 0; i < fileInput.files.length; i++) dataTransfer.items.add(fileInput.files[i]);
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    fileNameSpan.textContent = `${fileInput.files.length} t·ªáp`;
                    jsonCodeTextarea.value = ''; // Clear the textarea
                    toggleSubmitButton();
                    toggleOkButton();
                } else {
                    alert('C√≥ l·ªói x·∫£y ra khi l∆∞u JSON code!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u JSON code!');
            });
        }

        function copyToClipboard() {
            const questionList = document.getElementById('question-list');
            if (!questionList) { alert('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ copy!'); return; }
            
            const copyButton = document.querySelector('.copy-button');
            const originalText = copyButton.innerHTML;
            
            // Get text content from question-list
            const textToCopy = questionList.innerText || questionList.textContent;
            
            // Use modern Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                // Modern async clipboard API
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyButton.innerHTML = 'ƒê√£ copy';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                    }, 1000);
                }).catch(err => {
                    console.error('Copy failed:', err);
                    alert('C√≥ l·ªói x·∫£y ra khi c·ªë g·∫Øng copy n·ªôi dung!');
                });
            } else {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    copyButton.innerHTML = 'ƒê√£ copy';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                    }, 1000);
                } catch (err) {
                    console.error('Copy failed:', err);
                    alert('C√≥ l·ªói x·∫£y ra khi c·ªë g·∫Øng copy n·ªôi dung!');
                }
                document.body.removeChild(textarea);
            }
        }

        // N·∫øu mu·ªën: t·∫£i ƒë·ªông docx n·∫øu ch∆∞a c√≥ (th·ª≠ v√†i CDN)
async function ensureDocxLoaded() {
  if (window.docx && (window.docx.Document || window.docx.default?.Document)) return;
  const urls = [
    'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js',
    'https://unpkg.com/docx@8.5.0/build/index.iife.js'
  ];
  for (const src of urls) {
    await new Promise(resolve => {
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => resolve();
      s.onerror = () => resolve(); // try next url on error
      document.head.appendChild(s);
    });
    if (window.docx) break;
  }
}

// H√†m xu·∫•t .docx ‚Äî an to√†n v·ªõi c·∫£ global docx ho·∫∑c default export
async function downloadDocx() {
  try {
    // ensure library exists (tries dynamic load if needed)
    if (!(window.docx || window.docx?.default)) {
      await ensureDocxLoaded();
    }
    // pick correct export (some builds put api under .default)
    const docxPkg = window.docx && window.docx.Document ? window.docx : (window.docx && window.docx.default ? window.docx.default : null);
    if (!docxPkg) throw new Error('docx kh√¥ng kh·∫£ d·ª•ng sau khi th·ª≠ t·∫£i. Ki·ªÉm tra console network.');

    const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, BorderStyle } = docxPkg;

    const qRoot = document.getElementById('question-list');
    if (!qRoot) { alert('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ xu·∫•t!'); return; }

    const children = [];
    
    // L·∫•y t·∫•t c·∫£ c√°c c√¢u h·ªèi
    const questionDivs = qRoot.querySelectorAll('div[style*="border-left"]');
    
    questionDivs.forEach((qDiv, index) => {
      // L·∫•y ID
      const idText = qDiv.querySelector('strong')?.nextSibling?.textContent?.trim() || '';
      if (idText) {
        children.push(new Paragraph({
          children: [new TextRun({ text: `ID: ${idText}`, bold: true })],
          spacing: { before: 200, after: 100 }
        }));
      }
      
      // L·∫•y c√¢u h·ªèi ch√≠nh
      const questionText = Array.from(qDiv.querySelectorAll('strong')).find(s => s.textContent.includes('C√¢u'))?.textContent || '';
      if (questionText) {
        children.push(new Paragraph({
          children: [new TextRun({ text: questionText, bold: true })],
          spacing: { after: 100 }
        }));
      }
      
      // Ki·ªÉm tra c√≥ b·∫£ng kh√¥ng (c√¢u k√©o th·∫£)
      const table = qDiv.querySelector('table');
      if (table) {
        const cells = Array.from(table.querySelectorAll('td')).map(td => td.textContent.trim());
        
        if (cells.length > 0) {
          // T·∫°o b·∫£ng trong Word
          const tableRows = [
            new TableRow({
              children: cells.map(cellText => 
                new TableCell({
                  children: [new Paragraph({
                    children: [new TextRun({ text: cellText })],
                    alignment: 'center'
                  })],
                  width: { size: 100 / cells.length, type: WidthType.PERCENTAGE },
                  borders: {
                    top: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                    bottom: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                    left: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                    right: { style: BorderStyle.SINGLE, size: 1, color: "000000" }
                  }
                })
              )
            })
          ];
          
          children.push(new Table({
            rows: tableRows,
            width: { size: 100, type: WidthType.PERCENTAGE }
          }));
          
          children.push(new Paragraph({ text: '', spacing: { after: 100 } }));
        }
        
        // L·∫•y c√°c c√¢u con (c√¢u gh√©p)
        const subQuestions = qDiv.querySelectorAll('div[style*="padding-left: 15px"]');
        subQuestions.forEach(subQ => {
          const subText = subQ.textContent.trim();
          if (subText) {
            children.push(new Paragraph({
              children: [new TextRun({ text: subText })],
              spacing: { after: 50 }
            }));
          }
        });
      } else {
        // C√°c lo·∫°i c√¢u h·ªèi kh√°c (tr·∫Øc nghi·ªám, ƒëi·ªÅn t·ª´)
        const ul = qDiv.querySelector('ul');
        if (ul) {
          const items = Array.from(ul.querySelectorAll('li'));
          items.forEach(li => {
            children.push(new Paragraph({
              children: [new TextRun({ text: li.textContent.trim() })],
              spacing: { after: 50 }
            }));
          });
        }
        
        // C√¢u ƒëi·ªÅn t·ª´ (c√≥ background m√†u xanh)
        const fillInDivs = qDiv.querySelectorAll('div[style*="background-color: #2C2F33"]');
        fillInDivs.forEach(fillDiv => {
          const subItems = fillDiv.querySelectorAll('div[style*="color: #3ba55d"]');
          subItems.forEach(item => {
            const text = item.textContent.trim();
            if (text) {
              children.push(new Paragraph({
                children: [new TextRun({ text: text, color: "2d7d46" })],
                spacing: { after: 50 }
              }));
            }
          });
        });
      }
      
      // Th√™m kho·∫£ng c√°ch gi·ªØa c√°c c√¢u h·ªèi
      children.push(new Paragraph({ text: '', spacing: { after: 200 } }));
    });

    const doc = new Document({
      styles: {
        default: {
          document: {
            run: {
              font: "Aptos (Body)",
              size: 24 // 24 half-points = 12pt
            }
          }
        }
      },
      sections: [{ properties: {}, children: children }]
    });

    const blob = await Packer.toBlob(doc);

    // d√πng FileSaver n·∫øu load, ng∆∞·ª£c l·∫°i d√πng link t·∫°m
    if (window.saveAs) {
      saveAs(blob, 'noi_dung.docx');
    } else {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'noi_dung.docx';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  } catch (err) {
    console.error('L·ªói khi t·∫°o docx:', err);
    alert('Kh√¥ng th·ªÉ t·∫°o file .docx. Ki·ªÉm tra console ƒë·ªÉ bi·∫øt l·ªói chi ti·∫øt.');
  }
}

    </script>
</body>
</html>
